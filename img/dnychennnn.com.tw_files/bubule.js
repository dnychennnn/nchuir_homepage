var Bubule={__init__:function(a){this._uuid=Tools.Math.uuid(6);this._$currentTarget=null;this._x=null;this._y=null;this._$bubule=null;this._showTimeoutId=null;this._hideTimeoutId=null;this._hasBeenAutoSelected=false;this._params=a;this._create()},_create:function(){this._$bubule=$("<div>").attr("id",this._uuid).addClass("bubule").css({display:"none",position:"absolute","max-width":this._params["max-width"]+"px"});if(this._params.style){this._$bubule.addClass(this._params.style)}$("body").append(this._$bubule);this._handleEventsForStickyBehavior()},saveEventProperties:function(a){this._x=a.pageX;this._y=a.pageY;this._$currentTarget=$(a.currentTarget);return this},show:function(){var a=this;this._resetHideTimeout();if(this._$currentTarget.hasClass("tipsterNoCache")){this._$currentTarget.removeData("bubule-content")}$.when(a._loadContent()).done(function(){a._show()})},hide:function(){var b=this;this._resetShowTimeout();var a=this._params.sticky?this._params.delay:0;this._hideTimeoutId=window.setTimeout(function(){if(b._params.autoselectContent){Tools.Range.unselectText(b._$bubule.attr("id"))}b._$bubule.fadeOut(b._params.fadeDelay)},a)},_loadContent:function(){var e=this;var a=new $.Deferred();var d;var c=this._$currentTarget.data("url");if(this._$currentTarget.data("bubule-content")){this._delayContentDeferedResolution(a);return a.promise()}if(!this._$currentTarget.data("bubule-content")&&!c&&this._$currentTarget.attr("title")){d=this._$currentTarget.attr("title");this._$currentTarget.data("bubule-content",d).attr("title","");this._delayContentDeferedResolution(a)}if(!this._$currentTarget.data("bubule-content")&&!c&&!this._$currentTarget.attr("title")){var b=this._$currentTarget.next();if(b.is(this._params.bubuleContentSelector)){d=b.html();b.remove()}this._$currentTarget.data("bubule-content",d);this._delayContentDeferedResolution(a)}if(!this._$currentTarget.data("bubule-content")&&c){this._showTimeoutId=window.setTimeout(function(){GANDI.Ajax.init(null,{url:c,dataType:"html",beforeSend:function(){$("body").addClass("progress")}},{defaultCallbacks:false}).on({success:function(f){e._$currentTarget.data("bubule-content",f);a.resolve()}}).on({complete:function(){$("body").removeClass("progress")}})},this._params.delay)}return a.promise()},_delayContentDeferedResolution:function(a){this._showTimeoutId=window.setTimeout(function(){a.resolve()},this._params.delay)},_show:function(){var f=this._$currentTarget.data("bubule-content");if(!f){return}f.replace(/<script\b[^<]*(?:(?!<\/script>)<[^<]*)*<\/script>/gi,"");this._hasBeenAutoSelected=false;this._$bubule.css({left:0,width:""}).html(f);var j=this._x;var g=this._y;var h=Math.ceil(this._$bubule.outerHeight());var a=Math.ceil(this._$bubule.outerWidth());var i=this._params.position;var c=this._params.positionOffset;var e=Math.ceil(this._$currentTarget.outerHeight());var l=Math.ceil(this._$currentTarget.outerWidth());var b=Math.ceil(this._$currentTarget.offset().left);var k=Math.ceil(this._$currentTarget.offset().top);if(this._$currentTarget.prop("tagName")=="AREA"){i="default"}var d=m(i);function m(n){switch(n){case"top":g=k-(h+c);j=b-(a/2-l/2);break;case"right":g=k-(h/2-e/2);j=b+l+c;break;case"bottom":g=k+e;j=b-(a/2-l/2);break;case"left":g=k-(h/2-e/2);j=b-(a+c);break;case"floating":g=k+e;j+=c;break;default:g+=c;j+=c;break}return{x:j,y:g}}if(i=="right"&&(d.x+a+c)>$(document).width()){i="left"}else{if(i=="left"&&(d.x-(a+c))<0){i="right"}}a=Math.ceil(this._$bubule.outerWidth());d=m(i);if(i=="floating"&&(d.x+a+c)>$(document).width()){d.x=$(document).width()-(a+c)}if(d.y<0){d.y=0}this._$bubule.css({left:d.x+"px",top:d.y+"px"}).fadeIn(this._params.fadeDelay);this._$bubule.css({"max-width":this._params["max-width"]+"px"});if(this._$bubule.get(0).scrollWidth>this._$bubule.innerWidth()){this._$bubule.css({"max-width":"none"})}},_handleEventsForStickyBehavior:function(){var a=this;this._$bubule.bind("mouseover",function(){a._resetHideTimeout();a._autoselectContent()});this._$bubule.bind("mouseout",function(){a.hide()})},_autoselectContent:function(){var a=this;if(!this._params.autoselectContent){return}if(!this._hasBeenAutoSelected){window.setTimeout(function(){Tools.Range.selectText(a._$bubule.attr("id"));a._hasBeenAutoSelected=true},a._params.fadeDelay)}},_resetShowTimeout:function(){clearTimeout(this._showTimeoutId);this._showTimeoutId=null},_resetHideTimeout:function(){clearTimeout(this._hideTimeoutId);this._hideTimeoutId=null}};Bubule=Class.$extend(Bubule);var BubuleManager={__classvars__:{_params:{},_storedInstances:{},declare:function(c){this._params=$.extend({autoselectContent:false,bubuleContentSelector:".bubuleContent",delay:300,fadeDelay:150,"max-width":300,position:"floating",positionOffset:10,sticky:true,style:"",targetElement:$(".bubule")},c);if(this._params.autoselectContent){this._params.sticky=true}var b=this._params.targetElement.selector;var a=this.getBubule(b);$(document).on("mouseover",b,function(d){a.saveEventProperties(d).show()});$(document).on("mouseout",b,function(d){a.hide()})},getBubule:function(a){if(!this._storedInstances[a]){this._storedInstances[a]=new Bubule(this._params)}return this._storedInstances[a]},hideAll:function(){$.each(this._storedInstances,function(b,a){a.hide()})}}};BubuleManager=Class.$extend(BubuleManager);